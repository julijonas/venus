\documentclass[a4paper,12pt]{article}
\usepackage[a4paper,margin=1in]{geometry}
\title{User Guide}
\author{SDP Group 15-H}
\usepackage{listings}
\usepackage{color}
\usepackage{graphicx}
\usepackage{parskip}
%\usepackage{titling}
\usepackage{array}
\usepackage{soul}

\graphicspath{ {images/} }

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}
\definecolor{lightgray}{rgb}{0.95,0.95,0.95}

\lstset{
  aboveskip=3mm,
  belowskip=3mm,
  showstringspaces=false,
  columns=flexible,
  basicstyle={\small\ttfamily},
  numbers=none,
  numberstyle=\tiny\color{gray},
  keywordstyle=\color{blue},
  commentstyle=\color{dkgreen},
  stringstyle=\color{mauve},
  breaklines=true,
  breakatwhitespace=true,
  tabsize=3,
  backgroundcolor=\color{lightgray}
}

\sethlcolor{lightgray}
\newcommand{\hg}[1]{\hl{\ttfamily #1}}

\begin{document}

\begin{figure}
    \vspace*{-3em}
    \centering
    \includegraphics[scale=.18]{logo.png}
\end{figure}

%\setlength{\droptitle}{-4em}
\maketitle

\section{Installation}

\subsection{Cloning the repository and setting up} \label{setup}

To clone the repository, execute in terminal:
\begin{lstlisting}
$ git clone https://github.com/julijonas/venus.git
\end{lstlisting}

Then go to the root directory of the project and create a Python virtual environment which will contain a local copy of the libraries needed for this project:
\begin{lstlisting}
$ cd venus
$ virtualenv --system-site-packages env
$ source env/bin/activate
\end{lstlisting}

Install the \textit{pyserial} library which is used to send data to Arduino through RF stick:
\begin{lstlisting}
$ pip install pyserial
\end{lstlisting}

To set the persistent radio chip configuration for a new Arduino board, connect to the PC with an USB cable, execute \hg{screen /dev/tty0} in terminal, and enter the following commands substituting the appropriate group number and radio frequency band:

\begin{lstlisting}
+++
ATID0015
ATAC
ATRP1
ATAC
ATCN80
ATAC
ATWR
ARDN
\end{lstlisting}

To close \hg{screen}, press \textit{Ctrl+A} and then \textit{X}. The identical steps have to be performed for a new RF stick.

To program the Arduino to receive and execute messages, open the Arduino IDE by executing \hg{arduino} in terminal. You'll need to add three libraries which can be found under \texttt{arduino/} in the project directory: \textit{ArduinoSerialCommand}, \textit{SDPArduino}, \textit{SimpleTimer}. In order to add a library, go to
\hg{Sketch -> Import Library... -> Add Library...} and choose the library directory you want to import. Then open the Arduino file \texttt{arduino/arduino.ino} using \hg{File -> Open...} and upload it to the board using \hg{File -> Upload}.

\section{Hardware overview}

At this stage of the course, we can say that the hardware part of our robot is done. Venus is a three wheels robot. There are two main driving wheels and one holonomic wheel placed sideways at the back which allows the robot to turn as well as does not cause problems moving backwards and forwards due to its holonomic property. All wheels are powered by NXT motors. 
\\There is also a kicker that is powered by a NXT motor with gears. The kicker operates by going backwards inside the robot from the starting low position and then kicks the ball forwards.
\\The grabber consists of two parts resembling arms and is placed on the sides of the front part of the robot. It is powered by Electric Technic Mini-Motor 9v with gears. 

\subsection{Use}

First thing you would need to do to be able to communicate to Venus, is to connect the RF stick to the machine you are running the commands from. Then after performing steps described in "Running instructions" section, you will be able to operate the robot.
\\If you make any changes to the Arduino code, you need to upload it before running the commands. Uploading can be done either via RF stick or cable connected to the Arduino board. 
\\In order to turn the robot on, connect the battery pack to the power board.
In order to swap the batteries, take them out, put them to charge and insert
the new batteries into the battery pack. Easy!

\section{Software overview}

\subsection{Running instructions}

Run the following command in the terminal from the project root directory if it has not been done already to enable the Python virtual environment which contains the required libraries:
\begin{lstlisting}
$ source env/bin/activate
\end{lstlisting}

In order to set the room containing the pitch, colors of the robot, and side of the goal, change the hard-coded parameters of \textit{init} method in \textit{control/holonomic.py} as detailed in Table \ref{tab:params}.
For example, if the room is 3.D04, the robot has the yellow team color and one green-coloured dot, and the robot is defending the goal closer to the computers, the line would be:
\begin{lstlisting}
def init(self, room_num=1, team_color='yellow', our_color='green', computer_goal=True):
\end{lstlisting}

\begin{table}[h!]
\centering
\begin{tabular}{ | l | l | l | l | l | l | l | l | }
    \cline{1-2} \cline{4-4} \cline{6-6} \cline{8-8}
    Room & \texttt{room\_num} & & \texttt{team\_color} & & \texttt{our\_color} & & \texttt{computer\_goal} \\ 
    \cline{1-2} \cline{4-4} \cline{6-6} \cline{8-8}
    3.D03 & 0 & & 'yellow' & & 'green' & & True \\ 
    \cline{1-2} \cline{4-4} \cline{6-6} \cline{8-8}
    3.D04 & 1 & & 'blue' & & 'pink' & & False \\ 
    \cline{1-2} \cline{4-4} \cline{6-6} \cline{8-8}
\end{tabular}
\caption{Allowed parameters for the \textit{init} method}
\label{tab:params}
\end{table}

Then ensure that the RF stick is plugged in. To start the application, make connections to the RF stick, vision feed, and get access to the command prompt, execute the following line:
\begin{lstlisting}
$ python main.py
\end{lstlisting}

\textbf{NB}: In case you make changes to the Arduino code, you should upload your changes to the board as detailed in Section \ref{setup}.

Then the operator of the robot can start entering the commands. The main command is \hg{hs} which starts the strategy. The listing of all commands is provided in Table \ref{tab:commands}.

\begin{table}[h!]
\centering
\begin{tabular}{ | p{9cm} | p{6.2cm} | }
    \hline
    Constantly run the strategy state machine &
    \small{\texttt{hs}} \\ \hline
%    Set configuration values &
%    \small{\texttt{init room\_num team\_color our\_color computer\_goal}} \\ \hline
%    Connect to the RF stick &
%    \small{\texttt{connect}} \\ \hline
%    Start the vision &
%    \small{\texttt{vision}} \\ \hline
    Output a picture of the potential field of the state &
    \small{\texttt{map state\_name}} \\ \hline
    Perform a holonomic motion (angles in degrees) &
    \small{\texttt{move direction\_angle turn\_angle}} \\ \hline
    Move forward (in cm, negative means backward) &
    \small{\texttt{f distance}} \\ \hline
    Rotate clockwise (in degrees, negative means anticlockwise) &
    \small{\texttt{c angle}} \\ \hline
    Stop all motors &
    \small{\texttt{s}} \\ \hline
    Open the grabber &
    \small{\texttt{o}} \\ \hline
    Close the grabber &
    \small{\texttt{g}} \\ \hline
    Perform a spin kick &
    \small{\texttt{ee}} \\ \hline
    Print world state &
    \small{\texttt{w}} \\ \hline
    Query light sensor &
    \small{\texttt{query\_ball}} \\ \hline
    Pass the ball to the teammate &
    \small{\texttt{pass\_ball}} \\ \hline
    Catch the ball coming from the teammate &
    \small{\texttt{catch\_ball}} \\ \hline
    Kick the ball to the goal &
    \small{\texttt{goal}} \\ \hline
    Exit the application &
    \small{\texttt{exit}} \\ \hline
\end{tabular}
\caption{Commands available for the operator of the robot}
\label{tab:commands}
\end{table}

To catch the ball from the teammate, the robot turns towards the teammate and opens its grabber. When the ball is kicked towards the robot, the ball is grabbed. In case the ball bounces off, the robot starts moving to grab the ball. To pass the ball to the teammate, the robot turns towards the teammate and kicks the ball. The kick distance of the ball is calculated so that the ball can successfully reach the teammate.

\subsection{Calibration of the vision} \label{calibration}

copy over from spec

\subsection{Handling} \label{handling}

Handle the robot with care. It is advisable not to lose the top plate during the game. It can be secured properly to the robot using Blu-Tack. Before playing a match, ensure that the spin-kick, going forward, and turning are calibrated. It can be done by repeatedly executing the respective commands with different input values, changing the data points in the \texttt{calibration.ods} spreadsheet, and changing the equations in \texttt{ee}, \texttt{f}, and \texttt{c} methods in \texttt{control/holonomic.py} to respective new computed equations from the spreadsheet. Another important action is checking whether the light sensor threshold correctly identifies the grabbed ball and lack thereof. The threshold is defined in \texttt{query\_ball} method in \texttt{control/holonomic.py}.

\textbf{NB}: If another robot is doing the kick-off in a game, do not start the strategy by typing \hg{hs} before that robot performs the kick-off.

\section{Troubleshooting guide}

\textbf{Problem 1}: When uploading the code to the Arduino board, the following error message appears:
\begin{lstlisting}
processing.app.SerialNotFoundException: Serial port '<port>' not found. Did you select the right one from the Tools > Serial Port menu?
\end{lstlisting}

\textbf{Solution}: Make sure you are not running the Python application at the same time or have not opened the serial interface any other way when the changes are being uploaded. The Arduino IDE is only able to program the Arduino when the serial interface of the RF stick or Arduino itself is registered as \texttt{/dev/ttyACM0} on the PC. If there are other programs accessing \texttt{/dev/ttyACM0} and the RF stick or USB cable is unplugged and plugged again, the "new" device is issued \texttt{/dev/ttyACM1} instead by the Linux kernel.

\bigskip

\textbf{Problem 2}: When sending commands the robot does not respond to any commands although it should move.

\textbf{Solution}: Power cycle the Arduino board.

\bigskip

\textbf{Problem 3}: The distortion and color ranges vary on different machines and pitches.

\textbf{Solution}: Recalibrate the vision system as detailed in Section \ref{calibration}.

\bigskip

\textbf{Problem 4}: The spin kick is not reliable.

\textbf{Solution}: Recalibrate the spin kick as detailed in Section \ref{handling}.

\bigskip

\textbf{Problem 5}: The Python application cannot connect to the RF stick because the RF stick has registered itself as \texttt{/dev/ttyACM1}.

\textbf{Solution}: Either close all programs that have handles to \texttt{/dev/ttyACM0} and reconnect the RF stick or change the \texttt{device\_no} parameter in the \texttt{connect} method in \texttt{control/holonomic.py} to 1 and restart the Python application.

\bigskip

\textbf{Problem 6}: The robot moves unusually slow.

\textbf{Solution}: Change the battery set to a fully charged one.

\bigskip

\textbf{Problem 7}: The commands are evidently sent but the robot does not move.

\textbf{Solution}: Power cycle the Arduino. If that does not help, change the battery set to a fully charged one.

\bigskip

\textbf{Problem 8}: The freshly charged batteries are hot.

\textbf{Solution}: Do not put such battery set into the Arduino as the motions will not be reliable. Wait for them to cool down and obtain another set instead.

\end{document}